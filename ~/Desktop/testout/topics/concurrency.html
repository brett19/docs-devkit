<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="Couchbase Server product documentation"><style>
					body{
						padding-top:60px; /* make the container go all the way to the bottom of the top bar */
					}</style><link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet"></head><body><header class="navbar navbar-inverse navbar-fixed-top"><div class="navbar-inner"><div class="container-fluid container"><a class="brand" href="/">Couchbase Documentation</a></div></div></header><div id="content" class="container-fluid container"><div class="row-fluid"><nav class="span3"><div class="well"><ul class="nav nav-list"><li><a href="../topics/intro.html">Introduction</a></li><li><a href="../topics/getting-started.html">Getting Started</a></li><li><a href="../topics/tutorial-intro.html">Tutorial</a></li><li>Advanced usage</li><li>Using the APIs<ul class="nav nav-list"><li><a href="../topics/data-types.html">Data types with Node.js</a></li><li class="active"><a href="../topics/concurrency.html">Concurrency with CAS and Locking</a><ul class="nav nav-list"></ul></li><li><a href="../topics/callback.html">Callback and MultiCallback Format</a></li><li><a href="../topics/error-handling.html">Error Handling</a></li></ul></li></ul></div></nav><main class="span9">
	<h1 class="title topictitle1">Concurrency with CAS and Locking</h1>

	<div class="body conbody">
		<p class="p">In production deployments, it is possible that you will have more than a single instance of
			your application trying to modify the same key. In this case a race condition happens in
			which a modification one instance has made is immediately overridden.</p>

		<p class="p">Consider this code:</p>

<pre class="pre codeblock">
function add_friend(user_id, friend_id) {
  bucket.get('user_id-' + user_id, function(err, result) {
    result.value.friends[friend_id] = { 'added': new Date() };
    bucket.set('user_id-' + user_id, result.value, function(err, result) { } );
  });
}
</pre>

		<p class="p">In this case, friends is an array of friends the user has added, with the keys being the
			friend IDs, and the values being the time when they were added.</p>

		<p class="p">When the friend has been added to the array, the document is stored again on the
			server.</p>

		<p class="p">Assume that two users add the same friend at the same time, in this case there is a race
			condition where one version of the friends array ultimately wins.</p>

		<p class="p">Couchbase provides two means by which to solve for this problem. The first is called
			Opportunistic Locking and the second is called Pessimistic Locking.</p>

		<p class="p">Both forms of locking involve using a CAS value. This value indicates the state of a
			document at a specific time. Whenever a document is modified, this value changes. The
			contents of this value are not significant to the application, however it can be used to
			ensure consistency. You can pass the CAS of the value as it is known to the application and
			have the server make the operation fail if the current (server-side) CAS value differs.</p>

	</div>

</main></div></div><hr><footer><p style="text-align: center;">copyright 2014 <a href="http://www.couchbase.com/">Couchbase</a></p></footer><script src="http://code.jquery.com/jquery-1.9.1.min.js"></script><script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script></body></html>